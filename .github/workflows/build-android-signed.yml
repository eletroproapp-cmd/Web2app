name: Build Android (Signed for Play Store)

on:
  workflow_dispatch:
    inputs:
      config_url:
        description: 'URL para buscar a configuraÃ§Ã£o do build'
        required: true
        type: string
      build_id:
        description: 'ID do build para tracking'
        required: true
        type: string
      webhook_url:
        description: 'URL do webhook para notificar progresso'
        required: true
        type: string

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

jobs:
  validate-secrets:
    runs-on: ubuntu-latest
    outputs:
      has_signing_config: ${{ steps.check.outputs.has_config }}
    steps:
      - name: Check signing secrets
        id: check
        run: |
          MISSING=""
          if [ -z "${{ secrets.UPLOAD_KEYSTORE_BASE64 }}" ]; then MISSING="$MISSING UPLOAD_KEYSTORE_BASE64"; fi
          if [ -z "${{ secrets.UPLOAD_KEY_ALIAS }}" ]; then MISSING="$MISSING UPLOAD_KEY_ALIAS"; fi
          if [ -z "${{ secrets.UPLOAD_KEYSTORE_PASSWORD }}" ]; then MISSING="$MISSING UPLOAD_KEYSTORE_PASSWORD"; fi
          if [ -z "${{ secrets.UPLOAD_KEY_PASSWORD }}" ]; then MISSING="$MISSING UPLOAD_KEY_PASSWORD"; fi
          
          if [ -z "$MISSING" ]; then
            echo "has_config=true" >> $GITHUB_OUTPUT
            echo "ðŸ” All signing secrets configured!"
          else
            echo "has_config=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Missing secrets:$MISSING"
          fi

  fetch-config:
    runs-on: ubuntu-latest
    outputs:
      app_id: ${{ steps.config.outputs.app_id }}
      app_name: ${{ steps.config.outputs.app_name }}
      web_url: ${{ steps.config.outputs.web_url }}
      icon_url: ${{ steps.config.outputs.icon_url }}
    steps:
      - name: Fetch build configuration
        id: config
        run: |
          CONFIG_URL="${{ inputs.config_url }}"
          RESPONSE=$(curl -s "$CONFIG_URL")
          
          echo "app_id=$(echo "$RESPONSE" | jq -r '.config.appId')" >> $GITHUB_OUTPUT
          echo "app_name=$(echo "$RESPONSE" | jq -r '.config.appName')" >> $GITHUB_OUTPUT
          echo "web_url=$(echo "$RESPONSE" | jq -r '.config.webUrl')" >> $GITHUB_OUTPUT
          echo "icon_url=$(echo "$RESPONSE" | jq -r '.config.iconUrl // empty')" >> $GITHUB_OUTPUT

  build:
    needs: [validate-secrets, fetch-config]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Notify build started (10%)
        run: |
          curl -X POST "${{ inputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d '{"build_id": "${{ inputs.build_id }}", "status": "validating", "progress": 10}' || true

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: android-actions/setup-android@v3

      - name: Install SDK 35
        run: sdkmanager "platforms;android-35" "build-tools;35.0.0"

      - name: Decode keystore
        if: ${{ needs.validate-secrets.outputs.has_signing_config == 'true' }}
        run: |
          echo "${{ secrets.UPLOAD_KEYSTORE_BASE64 }}" | tr -d '[:space:]' | base64 -d > upload-key.jks
          echo "âœ… Keystore decoded: $(stat -c%s upload-key.jks) bytes"

      - name: Create web build
        run: |
          mkdir -p www
          cat > www/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <script>window.location.href = "${{ needs.fetch-config.outputs.web_url }}";</script>
          </head>
          <body></body>
          </html>
          EOF

      - name: Notify building (30%)
        run: |
          curl -X POST "${{ inputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d '{"build_id": "${{ inputs.build_id }}", "status": "building", "progress": 30}' || true

      - run: npm install --legacy-peer-deps
      - run: npx cap add android

      - name: Configure SDK versions
        run: |
          cat > android/variables.gradle << 'EOF'
          ext {
              minSdkVersion = 24
              compileSdkVersion = 35
              targetSdkVersion = 35
              buildToolsVersion = "35.0.0"
              androidxActivityVersion = '1.8.0'
              androidxAppCompatVersion = '1.6.1'
              androidxCoordinatorLayoutVersion = '1.2.0'
              androidxCoreVersion = '1.12.0'
              androidxFragmentVersion = '1.6.2'
              coreSplashScreenVersion = '1.0.1'
              androidxWebkitVersion = '1.9.0'
              junitVersion = '4.13.2'
              androidxJunitVersion = '1.1.5'
              androidxEspressoCoreVersion = '3.5.1'
              cordovaAndroidVersion = '10.1.1'
          }
          EOF

      - name: Process app icon
        if: ${{ needs.fetch-config.outputs.icon_url != '' }}
        run: |
          sudo apt-get update && sudo apt-get install -y imagemagick
          curl -L -o icon.png "${{ needs.fetch-config.outputs.icon_url }}"
          for d in mdpi:48 hdpi:72 xhdpi:96 xxhdpi:144 xxxhdpi:192; do
            DENSITY=${d%:*}; SIZE=${d#*:}
            mkdir -p android/app/src/main/res/mipmap-$DENSITY
            convert icon.png -resize ${SIZE}x${SIZE} android/app/src/main/res/mipmap-$DENSITY/ic_launcher.png
            cp android/app/src/main/res/mipmap-$DENSITY/ic_launcher.png android/app/src/main/res/mipmap-$DENSITY/ic_launcher_round.png
            cp android/app/src/main/res/mipmap-$DENSITY/ic_launcher.png android/app/src/main/res/mipmap-$DENSITY/ic_launcher_foreground.png
          done

      - name: Update app config
        run: |
          APP_ID="${{ needs.fetch-config.outputs.app_id }}"
          APP_NAME="${{ needs.fetch-config.outputs.app_name }}"
          
          sed -i "s/applicationId \"[^\"]*\"/applicationId \"$APP_ID\"/" android/app/build.gradle
          sed -i "s/namespace \"[^\"]*\"/namespace \"$APP_ID\"/" android/app/build.gradle
          sed -i "s/<string name=\"app_name\">[^<]*</<string name=\"app_name\">$APP_NAME</" android/app/src/main/res/values/strings.xml

      - name: Notify signing (50%)
        run: |
          curl -X POST "${{ inputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d '{"build_id": "${{ inputs.build_id }}", "status": "signing", "progress": 50}' || true

      - name: Configure signing (inject into existing android block)
        if: ${{ needs.validate-secrets.outputs.has_signing_config == 'true' }}
        run: |
          cp upload-key.jks android/app/upload-key.jks
          
          # Inject signingConfigs INSIDE the existing android { } block
          # Find the line with "android {" and inject after it
          sed -i '/^android {/a\
              signingConfigs {\
                  release {\
                      storeFile file("upload-key.jks")\
                      storePassword "${{ secrets.UPLOAD_KEYSTORE_PASSWORD }}"\
                      keyAlias "${{ secrets.UPLOAD_KEY_ALIAS }}"\
                      keyPassword "${{ secrets.UPLOAD_KEY_PASSWORD }}"\
                  }\
              }' android/app/build.gradle
          
          # Update buildTypes release to use the signing config
          sed -i 's/buildTypes {/buildTypes {\n        release {\n            signingConfig signingConfigs.release\n        }/' android/app/build.gradle
          
          echo "âœ… Signing config injected"

      - run: npx cap sync android

      - name: Debug Gradle - Show build.gradle content
        run: |
          echo "========== android/app/build.gradle =========="
          cat android/app/build.gradle
          echo ""
          echo "========== android/variables.gradle =========="
          cat android/variables.gradle
          echo ""
          echo "========== Checking for duplicate android blocks =========="
          grep -n "^android {" android/app/build.gradle || echo "No duplicate android blocks found"

      - name: Build AAB
        run: |
          cd android && chmod +x gradlew
          if [ "${{ needs.validate-secrets.outputs.has_signing_config }}" == "true" ]; then
            ./gradlew bundleRelease assembleRelease --no-daemon --stacktrace
          else
            ./gradlew bundleDebug assembleDebug --no-daemon --stacktrace
          fi

      - name: Notify finalizing (80%)
        run: |
          curl -X POST "${{ inputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d '{"build_id": "${{ inputs.build_id }}", "status": "signing", "progress": 80}' || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: |
            android/app/build/outputs/apk/**/app-*.apk
            android/app/build/outputs/bundle/**/app-*.aab

      - name: Notify complete (100%)
        if: success()
        run: |
          curl -X POST "${{ inputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d "{\"build_id\": \"${{ inputs.build_id }}\", \"status\": \"complete\", \"progress\": 100, \"artifact_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" || true

      - name: Notify failed
        if: failure()
        run: |
          curl -X POST "${{ inputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d '{"build_id": "${{ inputs.build_id }}", "status": "failed", "error_message": "Build failed - check logs"}' || true
