name: Build Android (Signed for Play Store)

# ============================================
# Workflow para build assinado com Upload Key
# CompatÃ­vel com Play App Signing
# ============================================

on:
  workflow_dispatch:
    inputs:
      config_url:
        description: 'URL para buscar a configuraÃ§Ã£o do build'
        required: true
        type: string
      build_id:
        description: 'ID do build para tracking'
        required: true
        type: string
  
  repository_dispatch:
    types: [build-android-signed]

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true"

jobs:
  validate-secrets:
    runs-on: ubuntu-latest
    outputs:
      has_signing_config: ${{ steps.check.outputs.has_config }}
    steps:
      - name: Check signing secrets
        id: check
        run: |
          if [ -n "${{ secrets.UPLOAD_KEYSTORE_BASE64 }}" ] && \
             [ -n "${{ secrets.UPLOAD_KEY_ALIAS }}" ] && \
             [ -n "${{ secrets.UPLOAD_KEYSTORE_PASSWORD }}" ] && \
             [ -n "${{ secrets.UPLOAD_KEY_PASSWORD }}" ]; then
            echo "has_config=true" >> $GITHUB_OUTPUT
            echo "âœ… Signing secrets configurados"
          else
            echo "has_config=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Signing secrets nÃ£o configurados - build serÃ¡ unsigned"
          fi

  fetch-config:
    runs-on: ubuntu-latest
    outputs:
      app_id: ${{ steps.config.outputs.app_id }}
      app_name: ${{ steps.config.outputs.app_name }}
      web_url: ${{ steps.config.outputs.web_url }}
      icon_url: ${{ steps.config.outputs.icon_url }}
      webhook_url: ${{ steps.config.outputs.webhook_url }}
      capacitor_config: ${{ steps.config.outputs.capacitor_config }}
    
    steps:
      - name: Fetch build configuration
        id: config
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            CONFIG_URL="${{ github.event.client_payload.config_url }}"
            BUILD_ID="${{ github.event.client_payload.build_id }}"
          else
            CONFIG_URL="${{ inputs.config_url }}"
            BUILD_ID="${{ inputs.build_id }}"
          fi
          
          echo "ðŸ“¥ Buscando config de: $CONFIG_URL"
          RESPONSE=$(curl -s "$CONFIG_URL?buildId=$BUILD_ID")
          
          APP_ID=$(echo "$RESPONSE" | jq -r '.config.appId')
          APP_NAME=$(echo "$RESPONSE" | jq -r '.config.appName')
          WEB_URL=$(echo "$RESPONSE" | jq -r '.config.webUrl')
          ICON_URL=$(echo "$RESPONSE" | jq -r '.config.iconUrl // empty')
          WEBHOOK_URL=$(echo "$RESPONSE" | jq -r '.config.buildMeta.webhookUrl')
          CAPACITOR_CONFIG=$(echo "$RESPONSE" | jq -c '.files["capacitor.config.json"]')
          
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "web_url=$WEB_URL" >> $GITHUB_OUTPUT
          echo "icon_url=$ICON_URL" >> $GITHUB_OUTPUT
          echo "webhook_url=$WEBHOOK_URL" >> $GITHUB_OUTPUT
          echo "capacitor_config=$CAPACITOR_CONFIG" >> $GITHUB_OUTPUT
          
          if [ "$APP_ID" == "null" ] || [ -z "$APP_ID" ]; then
            echo "âŒ ConfiguraÃ§Ã£o invÃ¡lida"
            exit 1
          fi

  build:
    needs: [validate-secrets, fetch-config]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Notify build started
        run: |
          curl -X POST "${{ needs.fetch-config.outputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ inputs.build_id || github.event.client_payload.build_id }}",
              "status": "validating",
              "progress": 10,
              "message": "Validando configuraÃ§Ã£o de assinatura"
            }' || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK 35
        run: |
          yes | sdkmanager "platforms;android-35" "build-tools;35.0.0"

      - name: Decode keystore
        if: ${{ needs.validate-secrets.outputs.has_signing_config == 'true' }}
        run: |
          echo "ðŸ” Decodificando keystore..."
          echo "${{ secrets.UPLOAD_KEYSTORE_BASE64 }}" | base64 -d > upload-key.jks
          echo "âœ… Keystore pronta"

      - name: Validate web URL
        run: |
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ needs.fetch-config.outputs.web_url }}")
          if [ "$HTTP_STATUS" != "200" ] && [ "$HTTP_STATUS" != "301" ] && [ "$HTTP_STATUS" != "302" ]; then
            curl -X POST "${{ needs.fetch-config.outputs.webhook_url }}" \
              -H "Content-Type: application/json" \
              -d '{"build_id": "${{ inputs.build_id || github.event.client_payload.build_id }}", "status": "failed", "error_message": "URL retornou status '$HTTP_STATUS'"}' || true
            exit 1
          fi

      - name: Create Capacitor config
        run: |
          echo '${{ needs.fetch-config.outputs.capacitor_config }}' | jq -r '.' > capacitor.config.json

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Create minimal web build
        run: |
          mkdir -p dist
          cat > dist/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${{ needs.fetch-config.outputs.app_name }}</title>
            <style>body{margin:0;display:flex;justify-content:center;align-items:center;height:100vh;background:#0f172a}.loader{width:48px;height:48px;border:4px solid #fff;border-bottom-color:#14b8a6;border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}</style>
          </head>
          <body><div class="loader"></div><script>window.location.href="${{ needs.fetch-config.outputs.web_url }}";</script></body>
          </html>
          EOF

      - name: Notify building
        run: |
          curl -X POST "${{ needs.fetch-config.outputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d '{"build_id": "${{ inputs.build_id || github.event.client_payload.build_id }}", "status": "building", "progress": 40, "message": "Preparando projeto Android"}' || true

      - name: Add Android platform
        run: npx cap add android
        - name: Force API 35 (compileSdk/targetSdk)
        run: |
          echo "ðŸ”§ Forcing API 35..."
          if [ -f android/app/build.gradle ]; then
            sed -i 's/compileSdkVersion[[:space:]]*[0-9]\+/compileSdkVersion 35/g' android/app/build.gradle || true
            sed -i 's/targetSdkVersion[[:space:]]*[0-9]\+/targetSdkVersion 35/g' android/app/build.gradle || true
            sed -i 's/compileSdk[[:space:]]*[0-9]\+/compileSdk 35/g' android/app/build.gradle || true
            sed -i 's/targetSdk[[:space:]]*[0-9]\+/targetSdk 35/g' android/app/build.gradle || true
          fi
          if [ -f android/variables.gradle ]; then
            sed -i 's/compileSdkVersion[[:space:]]*=[[:space:]]*[0-9]\+/compileSdkVersion = 35/g' android/variables.gradle || true
            sed -i 's/targetSdkVersion[[:space:]]*=[[:space:]]*[0-9]\+/targetSdkVersion = 35/g' android/variables.gradle || true
          fi
          if [ -f android/variables.gradle ]; then
            echo "Found android/variables.gradle"
            sed -i 's/compileSdkVersion[[:space:]]*=[[:space:]]*[0-9]\+/compileSdkVersion = 35/g' android/variables.gradle || true
            sed -i 's/targetSdkVersion[[:space:]]*=[[:space:]]*[0-9]\+/targetSdkVersion = 35/g' android/variables.gradle || true
          fi

          echo "âœ… Result (search compileSdk/targetSdk):"
          grep -RIn --line-number "compileSdk|compileSdkVersion|targetSdk|targetSdkVersion" android | head -n 200 || true

      - name: Download and process app icon
        if: ${{ needs.fetch-config.outputs.icon_url != '' }}
        run: |
          curl -L "${{ needs.fetch-config.outputs.icon_url }}" -o icon.png
          for size in 48 72 96 144 192; do
            folder=""
            case $size in 48) folder="mdpi";; 72) folder="hdpi";; 96) folder="xhdpi";; 144) folder="xxhdpi";; 192) folder="xxxhdpi";; esac
            mkdir -p android/app/src/main/res/mipmap-$folder
            convert icon.png -resize ${size}x${size} android/app/src/main/res/mipmap-$folder/ic_launcher.png 2>/dev/null || true
            convert icon.png -resize ${size}x${size} android/app/src/main/res/mipmap-$folder/ic_launcher_round.png 2>/dev/null || true
          done

      - name: Update Android configuration
        run: |
          sed -i "s/applicationId \".*\"/applicationId \"${{ needs.fetch-config.outputs.app_id }}\"/g" android/app/build.gradle
          sed -i "s/namespace \".*\"/namespace \"${{ needs.fetch-config.outputs.app_id }}\"/g" android/app/build.gradle

      - name: Configure signing in build.gradle
        if: ${{ needs.validate-secrets.outputs.has_signing_config == 'true' }}
        run: |
          # Adicionar configuraÃ§Ã£o de assinatura no build.gradle
          cat >> android/app/build.gradle << 'SIGNING_CONFIG'
          
          android {
              signingConfigs {
                  release {
                      storeFile file("${{ github.workspace }}/upload-key.jks")
                      storePassword "${{ secrets.UPLOAD_KEYSTORE_PASSWORD }}"
                      keyAlias "${{ secrets.UPLOAD_KEY_ALIAS }}"
                      keyPassword "${{ secrets.UPLOAD_KEY_PASSWORD }}"
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          SIGNING_CONFIG

      - name: Sync Capacitor
        run: |
          curl -X POST "${{ needs.fetch-config.outputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d '{"build_id": "${{ inputs.build_id || github.event.client_payload.build_id }}", "status": "building", "progress": 60, "message": "Sincronizando Capacitor"}' || true
          npx cap sync android

      - name: Notify signing
        run: |
          SIGNING_MSG="${{ needs.validate-secrets.outputs.has_signing_config == 'true' && 'Assinando com Upload Key' || 'Gerando AAB (unsigned)' }}"
          curl -X POST "${{ needs.fetch-config.outputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d "{\"build_id\": \"${{ inputs.build_id || github.event.client_payload.build_id }}\", \"status\": \"signing\", \"progress\": 80, \"message\": \"$SIGNING_MSG\"}" || true

      - name: Build signed AAB
        if: ${{ needs.validate-secrets.outputs.has_signing_config == 'true' }}
        working-directory: android
        run: |
          chmod +x gradlew
          ./gradlew bundleRelease --no-daemon
          echo "âœ… AAB assinado gerado com sucesso"

      - name: Build unsigned AAB (fallback)
        if: ${{ needs.validate-secrets.outputs.has_signing_config != 'true' }}
        working-directory: android
        run: |
          chmod +x gradlew
          ./gradlew bundleDebug --no-daemon
          echo "âš ï¸ AAB unsigned gerado (configure secrets para assinatura)"

      - name: Build APK for testing
        working-directory: android
        run: ./gradlew assembleDebug --no-daemon

      - name: Locate build outputs
        id: outputs
        run: |
          APK_PATH=$(find android/app/build/outputs -name "*.apk" | head -1)
          AAB_PATH=$(find android/app/build/outputs -name "*.aab" | head -1 || echo "")
          
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "aab_path=$AAB_PATH" >> $GITHUB_OUTPUT
          
          # Determinar se Ã© signed ou unsigned
          if [ "${{ needs.validate-secrets.outputs.has_signing_config }}" == "true" ]; then
            echo "signed=true" >> $GITHUB_OUTPUT
          else
            echo "signed=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload APK to storage
        id: upload_apk
        run: |
          BUILD_ID="${{ inputs.build_id || github.event.client_payload.build_id }}"
          APK_PATH="${{ steps.outputs.outputs.apk_path }}"
          APP_NAME="${{ needs.fetch-config.outputs.app_name }}"
          UPLOAD_URL="https://offkayttuaeolxegjkit.supabase.co/functions/v1/upload-artifact"
          
          echo "ðŸ“¤ Uploading APK..."
          RESPONSE=$(curl -s -X POST "$UPLOAD_URL" \
            -F "file=@$APK_PATH" \
            -F "build_id=$BUILD_ID" \
            -F "file_type=apk" \
            -F "app_name=$APP_NAME")
          
          APK_URL=$(echo "$RESPONSE" | jq -r '.url // empty')
          echo "apk_url=$APK_URL" >> $GITHUB_OUTPUT
          
          if [ -n "$APK_URL" ]; then
            echo "âœ… APK uploaded: $APK_URL"
          else
            echo "âš ï¸ APK upload failed, falling back to artifact"
          fi

      - name: Upload AAB to storage
        id: upload_aab
        if: ${{ steps.outputs.outputs.aab_path != '' }}
        run: |
          BUILD_ID="${{ inputs.build_id || github.event.client_payload.build_id }}"
          AAB_PATH="${{ steps.outputs.outputs.aab_path }}"
          APP_NAME="${{ needs.fetch-config.outputs.app_name }}"
          UPLOAD_URL="https://offkayttuaeolxegjkit.supabase.co/functions/v1/upload-artifact"
          
          echo "ðŸ“¤ Uploading AAB..."
          RESPONSE=$(curl -s -X POST "$UPLOAD_URL" \
            -F "file=@$AAB_PATH" \
            -F "build_id=$BUILD_ID" \
            -F "file_type=aab" \
            -F "app_name=$APP_NAME")
          
          AAB_URL=$(echo "$RESPONSE" | jq -r '.url // empty')
          echo "aab_url=$AAB_URL" >> $GITHUB_OUTPUT
          
          if [ -n "$AAB_URL" ]; then
            echo "âœ… AAB uploaded: $AAB_URL"
          else
            echo "âš ï¸ AAB upload failed, falling back to artifact"
          fi

      - name: Fallback - Upload APK artifact
        if: ${{ steps.upload_apk.outputs.apk_url == '' }}
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ inputs.build_id || github.event.client_payload.build_id }}-apk
          path: ${{ steps.outputs.outputs.apk_path }}
          retention-days: 7

      - name: Fallback - Upload AAB artifact
        if: ${{ steps.outputs.outputs.aab_path != '' && steps.upload_aab.outputs.aab_url == '' }}
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ inputs.build_id || github.event.client_payload.build_id }}-aab-${{ steps.outputs.outputs.signed == 'true' && 'signed' || 'unsigned' }}
          path: ${{ steps.outputs.outputs.aab_path }}
          retention-days: 7

      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f upload-key.jks 2>/dev/null || true
          echo "ðŸ§¹ Arquivos sensÃ­veis removidos"

      - name: Notify build complete
        run: |
          ARTIFACT_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          SIGNED_MSG="${{ steps.outputs.outputs.signed == 'true' && 'AAB assinado pronto para Play Store!' || 'AAB gerado (configure secrets para assinatura)' }}"
          AAB_URL="${{ steps.upload_aab.outputs.aab_url }}"
          APK_URL="${{ steps.upload_apk.outputs.apk_url }}"
          
          curl -X POST "${{ needs.fetch-config.outputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"build_id\": \"${{ inputs.build_id || github.event.client_payload.build_id }}\",
              \"status\": \"complete\",
              \"progress\": 100,
              \"artifact_url\": \"$ARTIFACT_URL\",
              \"aab_url\": \"$AAB_URL\",
              \"apk_url\": \"$APK_URL\",
              \"signed\": ${{ steps.outputs.outputs.signed }},
              \"message\": \"$SIGNED_MSG\"
            }"

      - name: Notify failure
        if: failure()
        run: |
          curl -X POST "${{ needs.fetch-config.outputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d '{"build_id": "${{ inputs.build_id || github.event.client_payload.build_id }}", "status": "failed", "error_message": "Build falhou. Verifique os logs."}' || true
