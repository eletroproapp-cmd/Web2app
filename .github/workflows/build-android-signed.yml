name: Build Android (Signed for Play Store)

## ============================================
## Workflow para build assinado com Upload Key
## CompatÃ­vel com Play App Signing
## API Level 35 (Google Play 2025+)
## ============================================

on:
  workflow_dispatch:
    inputs:
      config_url:
        description: 'URL para buscar a configuraÃ§Ã£o do build'
        required: true
        type: string
      build_id:
        description: 'ID do build para tracking'
        required: true
        type: string
  
  repository_dispatch:
    types: [build-android-signed]

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true"

jobs:
  validate-secrets:
    runs-on: ubuntu-latest
    outputs:
      has_signing_config: ${{ steps.check.outputs.has_config }}
    steps:
      - name: Check signing secrets
        id: check
        run: |
          MISSING=""
          
          if [ -z "${{ secrets.UPLOAD_KEYSTORE_BASE64 }}" ]; then
            MISSING="$MISSING UPLOAD_KEYSTORE_BASE64"
            echo "âŒ Missing: UPLOAD_KEYSTORE_BASE64"
          else
            echo "âœ… Found: UPLOAD_KEYSTORE_BASE64"
          fi
          
          if [ -z "${{ secrets.UPLOAD_KEY_ALIAS }}" ]; then
            MISSING="$MISSING UPLOAD_KEY_ALIAS"
            echo "âŒ Missing: UPLOAD_KEY_ALIAS"
          else
            echo "âœ… Found: UPLOAD_KEY_ALIAS"
          fi
          
          if [ -z "${{ secrets.UPLOAD_KEYSTORE_PASSWORD }}" ]; then
            MISSING="$MISSING UPLOAD_KEYSTORE_PASSWORD"
            echo "âŒ Missing: UPLOAD_KEYSTORE_PASSWORD"
          else
            echo "âœ… Found: UPLOAD_KEYSTORE_PASSWORD"
          fi
          
          if [ -z "${{ secrets.UPLOAD_KEY_PASSWORD }}" ]; then
            MISSING="$MISSING UPLOAD_KEY_PASSWORD"
            echo "âŒ Missing: UPLOAD_KEY_PASSWORD"
          else
            echo "âœ… Found: UPLOAD_KEY_PASSWORD"
          fi
          
          if [ -z "$MISSING" ]; then
            echo "has_config=true" >> $GITHUB_OUTPUT
            echo ""
            echo "ðŸ” All signing secrets configured!"
          else
            echo "has_config=false" >> $GITHUB_OUTPUT
            echo ""
            echo "âš ï¸ Missing secrets:$MISSING"
            echo "âš ï¸ Build will be UNSIGNED (debug mode)"
          fi

  fetch-config:
    runs-on: ubuntu-latest
    outputs:
      app_id: ${{ steps.config.outputs.app_id }}
      app_name: ${{ steps.config.outputs.app_name }}
      web_url: ${{ steps.config.outputs.web_url }}
      icon_url: ${{ steps.config.outputs.icon_url }}
      webhook_url: ${{ steps.config.outputs.webhook_url }}
      capacitor_config: ${{ steps.config.outputs.capacitor_config }}
    
    steps:
      - name: Fetch build configuration
        id: config
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            CONFIG_URL="${{ github.event.client_payload.config_url }}"
            BUILD_ID="${{ github.event.client_payload.build_id }}"
          else
            CONFIG_URL="${{ inputs.config_url }}"
            BUILD_ID="${{ inputs.build_id }}"
          fi
          
          echo "ðŸ“¥ Fetching config from: $CONFIG_URL?buildId=$BUILD_ID"
          RESPONSE=$(curl -s "$CONFIG_URL?buildId=$BUILD_ID")
          
          echo "ðŸ“„ Response preview:"
          echo "$RESPONSE" | head -c 500
          echo ""
          
          APP_ID=$(echo "$RESPONSE" | jq -r '.config.appId')
          APP_NAME=$(echo "$RESPONSE" | jq -r '.config.appName')
          WEB_URL=$(echo "$RESPONSE" | jq -r '.config.webUrl')
          ICON_URL=$(echo "$RESPONSE" | jq -r '.config.iconUrl // empty')
          WEBHOOK_URL=$(echo "$RESPONSE" | jq -r '.config.buildMeta.webhookUrl')
          CAPACITOR_CONFIG=$(echo "$RESPONSE" | jq -c '.files["capacitor.config.json"]')
          
          echo ""
          echo "ðŸ“± App ID: $APP_ID"
          echo "ðŸ“± App Name: $APP_NAME"
          echo "ðŸŒ Web URL: $WEB_URL"
          echo "ðŸ–¼ï¸ Icon URL: $ICON_URL"
          echo "ðŸ”— Webhook URL: $WEBHOOK_URL"
          
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "web_url=$WEB_URL" >> $GITHUB_OUTPUT
          echo "icon_url=$ICON_URL" >> $GITHUB_OUTPUT
          echo "webhook_url=$WEBHOOK_URL" >> $GITHUB_OUTPUT
          echo "capacitor_config=$CAPACITOR_CONFIG" >> $GITHUB_OUTPUT
          
          if [ "$APP_ID" == "null" ] || [ -z "$APP_ID" ]; then
            echo ""
            echo "âŒ Invalid configuration - APP_ID is null or empty"
            echo "âŒ Full response:"
            echo "$RESPONSE"
            exit 1
          fi
          
          echo ""
          echo "âœ… Configuration loaded successfully"

  build:
    needs: [validate-secrets, fetch-config]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Notify build started
        run: |
          curl -X POST "${{ needs.fetch-config.outputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ inputs.build_id || github.event.client_payload.build_id }}",
              "status": "validating",
              "progress": 10,
              "message": "Validando configuraÃ§Ã£o de assinatura"
            }' || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK 35
        run: |
          echo "ðŸ“¦ Installing Android SDK Platform 35..."
          sdkmanager "platforms;android-35" "build-tools;35.0.0"
          echo "âœ… SDK 35 installed"

      - name: Decode keystore
        if: ${{ needs.validate-secrets.outputs.has_signing_config == 'true' }}
        run: |
          echo "ðŸ” Decoding keystore..."
          echo "${{ secrets.UPLOAD_KEYSTORE_BASE64 }}" | tr -d '[:space:]' | base64 -d > upload-key.jks
          
          if [ -f upload-key.jks ] && [ -s upload-key.jks ]; then
            FILE_SIZE=$(stat -c%s upload-key.jks 2>/dev/null || stat -f%z upload-key.jks 2>/dev/null)
            echo "âœ… Keystore decoded: $FILE_SIZE bytes"
          else
