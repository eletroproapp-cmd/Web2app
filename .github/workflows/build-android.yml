name: Build Android (Signed for Play Store)

on:
  workflow_dispatch:
    inputs:
      config_url:
        description: 'URL para buscar a configura√ß√£o do build'
        required: true
        type: string
      build_id:
        description: 'ID do build para tracking'
        required: true
        type: string
  
  repository_dispatch:
    types: [build-android-signed]

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true"

jobs:
  validate-secrets:
    runs-on: ubuntu-latest
    outputs:
      has_signing_config: ${{ steps.check.outputs.has_config }}
    steps:
      - name: Check signing secrets
        id: check
        run: |
          if [ -n "${{ secrets.UPLOAD_KEYSTORE_BASE64 }}" ]; then echo "has_config=true" >> $GITHUB_OUTPUT; else echo "has_config=false" >> $GITHUB_OUTPUT; fi

  fetch-config:
    runs-on: ubuntu-latest
    outputs:
      app_id: ${{ steps.config.outputs.app_id }}
      app_name: ${{ steps.config.outputs.app_name }}
      web_url: ${{ steps.config.outputs.web_url }}
      icon_url: ${{ steps.config.outputs.icon_url }}
      webhook_url: ${{ steps.config.outputs.webhook_url }}
      capacitor_config: ${{ steps.config.outputs.capacitor_config }}
    steps:
      - name: Fetch build configuration
        id: config
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            CONFIG_URL="${{ github.event.client_payload.config_url }}"
            BUILD_ID="${{ github.event.client_payload.build_id }}"
          else
            CONFIG_URL="${{ inputs.config_url }}"
            BUILD_ID="${{ inputs.build_id }}"
          fi
          RESPONSE=$(curl -s "$CONFIG_URL?buildId=$BUILD_ID")
          echo "app_id=$(echo "$RESPONSE" | jq -r '.config.appId')" >> $GITHUB_OUTPUT
          echo "app_name=$(echo "$RESPONSE" | jq -r '.config.appName')" >> $GITHUB_OUTPUT
          echo "web_url=$(echo "$RESPONSE" | jq -r '.config.webUrl')" >> $GITHUB_OUTPUT
          echo "icon_url=$(echo "$RESPONSE" | jq -r '.config.iconUrl // empty')" >> $GITHUB_OUTPUT
          echo "webhook_url=$(echo "$RESPONSE" | jq -r '.config.buildMeta.webhookUrl')" >> $GITHUB_OUTPUT
          echo "capacitor_config=$(echo "$RESPONSE" | jq -c '.files["capacitor.config.json"]')" >> $GITHUB_OUTPUT

  build:
    needs: [validate-secrets, fetch-config]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node/Java/Android
        uses: actions/setup-node@v4
        with: { node-version: '20' }
      
      - uses: actions/setup-java@v4
        with: { distribution: 'temurin', java-version: '17' }
      
      - uses: android-actions/setup-android@v3

      - name: Install SDK 35
        run: sdkmanager --install "platforms;android-35" "build-tools;35.0.0"

      - name: Decode keystore
        if: ${{ needs.validate-secrets.outputs.has_signing_config == 'true' }}
        run: echo "${{ secrets.UPLOAD_KEYSTORE_BASE64 }}" | base64 -d > upload-key.jks

      - name: Create Capacitor config
        run: echo '${{ needs.fetch-config.outputs.capacitor_config }}' | jq -r '.' > capacitor.config.json

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Create dist folder
        run: |
          mkdir -p dist
          cat > dist/index.html << 'EOF'
          <!DOCTYPE html><html><head><meta charset="UTF-8"><title>${{ needs.fetch-config.outputs.app_name }}</title></head>
          <body style="background:#0f172a"><script>window.location.href="${{ needs.fetch-config.outputs.web_url }}";</script></body></html>
          EOF

      - name: Add Android platform
        run: npx cap add android

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Force Android API 35 everywhere (after cap sync)
        run: |
          set -e
          echo "üîß For√ßando compileSdk/targetSdk = 35 (Play Console requirement)..."

          # variables.gradle (Capacitor geralmente usa isso)
          if [ -f android/variables.gradle ]; then
            sed -i 's/compileSdkVersion = .*/compileSdkVersion = 35/' android/variables.gradle || true
            sed -i 's/targetSdkVersion = .*/targetSdkVersion = 35/' android/variables.gradle || true
            sed -i 's/minSdkVersion = .*/minSdkVersion = 23/' android/variables.gradle || true
          fi

          # Groovy DSL
          if [ -f android/app/build.gradle ]; then
            sed -i 's/compileSdkVersion[[:space:]]*[0-9]\+/compileSdkVersion 35/g' android/app/build.gradle || true
            sed -i 's/compileSdk[[:space:]]*[0-9]\+/compileSdk 35/g' android/app/build.gradle || true
            sed -i 's/targetSdkVersion[[:space:]]*[0-9]\+/targetSdkVersion 35/g' android/app/build.gradle || true
            sed -i 's/targetSdk[[:space:]]*[0-9]\+/targetSdk 35/g' android/app/build.gradle || true
            sed -i 's/minSdkVersion[[:space:]]*[0-9]\+/minSdkVersion 23/g' android/app/build.gradle || true
            sed -i 's/minSdk[[:space:]]*[0-9]\+/minSdk 23/g' android/app/build.gradle || true
          fi

          # Kotlin DSL (se existir)
          if [ -f android/app/build.gradle.kts ]; then
            sed -i 's/compileSdk = [0-9]\+/compileSdk = 35/g' android/app/build.gradle.kts || true
            sed -i 's/targetSdk = [0-9]\+/targetSdk = 35/g' android/app/build.gradle.kts || true
            sed -i 's/minSdk = [0-9]\+/minSdk = 23/g' android/app/build.gradle.kts || true
          fi

          echo "üîç Checagem:"
          echo "--- android/variables.gradle ---"
          grep -E "(compileSdk|targetSdk|minSdk)" android/variables.gradle 2>/dev/null || true
          echo "--- android/app/build.gradle ---"
          grep -E "(compileSdk|targetSdk|minSdk)" android/app/build.gradle 2>/dev/null || true
          echo "--- android/app/build.gradle.kts ---"
          grep -E "(compileSdk|targetSdk|minSdk)" android/app/build.gradle.kts 2>/dev/null || true
        
      - name: Update Android configuration (NAME & VERSION)
        run: |
          VERSION_CODE=${{ github.run_number }}
          VERSION_NAME="1.0.${{ github.run_number }}"
          APP_NAME="${{ needs.fetch-config.outputs.app_name }}"
          PACKAGE_ID=$(echo "${{ needs.fetch-config.outputs.app_id }}" | sed 's/ (unregistered)//g')
          
          # 1. For√ßar Nome do App em strings.xml (O que aparece no √≠cone)
          STRINGS_FILE="android/app/src/main/res/values/strings.xml"
          echo "<?xml version='1.0' encoding='utf-8'?><resources><string name='app_name'>$APP_NAME</string><string name='title_activity_main'>$APP_NAME</string><string name='package_name'>$PACKAGE_ID</string></resources>" > $STRINGS_FILE
          
          # 2. Update build.gradle (ID e Vers√£o)
          BUILD_GRADLE="android/app/build.gradle"
          sed -i "s/applicationId \".*\"/applicationId \"$PACKAGE_ID\"/g" "$BUILD_GRADLE"
          sed -i "s/namespace \".*\"/namespace \"$PACKAGE_ID\"/g" "$BUILD_GRADLE"
          sed -i "s/versionCode .*/versionCode $VERSION_CODE/" "$BUILD_GRADLE"
          sed -i "s/versionName .*/versionName \"$VERSION_NAME\"/" "$BUILD_GRADLE"
          
          # 3. Update AndroidManifest.xml (Label do App)
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          sed -i "s/android:label=\".*\"/android:label=\"@string\/app_name\"/g" "$MANIFEST"
          
          echo "‚úÖ Configura√ß√µes de Nome e Vers√£o aplicadas"

      - name: Download and Force App Icon
        if: ${{ needs.fetch-config.outputs.icon_url != '' }}
        run: |
          sudo apt-get update && sudo apt-get install -y imagemagick
          curl -L "${{ needs.fetch-config.outputs.icon_url }}" -o icon.png
          
          # Gerar √≠cones para TODAS as pastas poss√≠veis do Android
          for size in 48 72 96 144 192 512; do
            case $size in 
              48) folder="mdpi";; 72) folder="hdpi";; 96) folder="xhdpi";; 
              144) folder="xxhdpi";; 192) folder="xxxhdpi";; 512) folder="playstore";;
            esac
            
            if [ "$folder" != "playstore" ]; then
              mkdir -p android/app/src/main/res/mipmap-$folder
              convert icon.png -resize ${size}x${size} android/app/src/main/res/mipmap-$folder/ic_launcher.png
              convert icon.png -resize ${size}x${size} android/app/src/main/res/mipmap-$folder/ic_launcher_round.png
              # Tamb√©m copiar para a pasta drawable como fallback
              mkdir -p android/app/src/main/res/drawable-$folder
              convert icon.png -resize ${size}x${size} android/app/src/main/res/drawable-$folder/ic_launcher.png
            fi
          done
          echo "‚úÖ √çcones gerados e substitu√≠dos em todas as densidades"

      - name: Configure signing
        if: ${{ needs.validate-secrets.outputs.has_signing_config == 'true' }}
        run: |
          cat >> android/app/build.gradle << 'SIGNING_CONFIG'
          android {
              signingConfigs { release {
                  storeFile file("${{ github.workspace }}/upload-key.jks")
                  storePassword "${{ secrets.UPLOAD_KEYSTORE_PASSWORD }}"
                  keyAlias "${{ secrets.UPLOAD_KEY_ALIAS }}"
                  keyPassword "${{ secrets.UPLOAD_KEY_PASSWORD }}"
              }}
              buildTypes { release { signingConfig signingConfigs.release } }
          }
          SIGNING_CONFIG

      - name: Gradle clean
        working-directory: android
        run: |
