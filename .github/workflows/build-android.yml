name: Build Android (Signed for Play Store)

# ============================================
# Workflow para build assinado com Upload Key
# Compat√≠vel com Play App Signing
# API Level 35 (Google Play 2025+)
# Auto-increment de versionCode
# ============================================

on:
  workflow_dispatch:
    inputs:
      config_url:
        description: 'URL para buscar a configura√ß√£o do build'
        required: true
        type: string
      build_id:
        description: 'ID do build para tracking'
        required: true
        type: string
  
  repository_dispatch:
    types: [build-android-signed]

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true"

jobs:
  validate-secrets:
    runs-on: ubuntu-latest
    outputs:
      has_signing_config: ${{ steps.check.outputs.has_config }}
    steps:
      - name: Check signing secrets
        id: check
        run: |
          MISSING=""
          
          if [ -z "${{ secrets.UPLOAD_KEYSTORE_BASE64 }}" ]; then
            MISSING="$MISSING UPLOAD_KEYSTORE_BASE64"
            echo "‚ùå Missing: UPLOAD_KEYSTORE_BASE64"
          else
            echo "‚úÖ Found: UPLOAD_KEYSTORE_BASE64"
          fi
          
          if [ -z "${{ secrets.UPLOAD_KEY_ALIAS }}" ]; then
            MISSING="$MISSING UPLOAD_KEY_ALIAS"
            echo "‚ùå Missing: UPLOAD_KEY_ALIAS"
          else
            echo "‚úÖ Found: UPLOAD_KEY_ALIAS"
          fi
          
          if [ -z "${{ secrets.UPLOAD_KEYSTORE_PASSWORD }}" ]; then
            MISSING="$MISSING UPLOAD_KEYSTORE_PASSWORD"
            echo "‚ùå Missing: UPLOAD_KEYSTORE_PASSWORD"
          else
            echo "‚úÖ Found: UPLOAD_KEYSTORE_PASSWORD"
          fi
          
          if [ -z "${{ secrets.UPLOAD_KEY_PASSWORD }}" ]; then
            MISSING="$MISSING UPLOAD_KEY_PASSWORD"
            echo "‚ùå Missing: UPLOAD_KEY_PASSWORD"
          else
            echo "‚úÖ Found: UPLOAD_KEY_PASSWORD"
          fi
          
          if [ -z "$MISSING" ]; then
            echo "has_config=true" >> $GITHUB_OUTPUT
            echo ""
            echo "üîê All signing secrets configured!"
          else
            echo "has_config=false" >> $GITHUB_OUTPUT
            echo ""
            echo "‚ö†Ô∏è Missing secrets:$MISSING"
            echo "‚ö†Ô∏è Build will be UNSIGNED (debug mode)"
          fi

  fetch-config:
    runs-on: ubuntu-latest
    outputs:
      app_id: ${{ steps.config.outputs.app_id }}
      app_name: ${{ steps.config.outputs.app_name }}
      web_url: ${{ steps.config.outputs.web_url }}
      icon_url: ${{ steps.config.outputs.icon_url }}
      webhook_url: ${{ steps.config.outputs.webhook_url }}
      capacitor_config: ${{ steps.config.outputs.capacitor_config }}
    
    steps:
      - name: Fetch build configuration
        id: config
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            CONFIG_URL="${{ github.event.client_payload.config_url }}"
            BUILD_ID="${{ github.event.client_payload.build_id }}"
          else
            CONFIG_URL="${{ inputs.config_url }}"
            BUILD_ID="${{ inputs.build_id }}"
          fi
          
          echo "üì• Fetching config from: $CONFIG_URL?buildId=$BUILD_ID"
          RESPONSE=$(curl -s "$CONFIG_URL?buildId=$BUILD_ID")
          
          echo "üìÑ Response preview:"
          echo "$RESPONSE" | head -c 500
          echo ""
          
          APP_ID=$(echo "$RESPONSE" | jq -r '.config.appId')
          APP_NAME=$(echo "$RESPONSE" | jq -r '.config.appName')
          WEB_URL=$(echo "$RESPONSE" | jq -r '.config.webUrl')
          ICON_URL=$(echo "$RESPONSE" | jq -r '.config.iconUrl // empty')
          WEBHOOK_URL=$(echo "$RESPONSE" | jq -r '.config.buildMeta.webhookUrl')
          CAPACITOR_CONFIG=$(echo "$RESPONSE" | jq -c '.files["capacitor.config.json"]')
          
          echo ""
          echo "üì± App ID: $APP_ID"
          echo "üì± App Name: $APP_NAME"
          echo "üåê Web URL: $WEB_URL"
          echo "üñºÔ∏è Icon URL: $ICON_URL"
          echo "üîó Webhook URL: $WEBHOOK_URL"
          
          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "web_url=$WEB_URL" >> $GITHUB_OUTPUT
          echo "icon_url=$ICON_URL" >> $GITHUB_OUTPUT
          echo "webhook_url=$WEBHOOK_URL" >> $GITHUB_OUTPUT
          echo "capacitor_config=$CAPACITOR_CONFIG" >> $GITHUB_OUTPUT
          
          if [ "$APP_ID" == "null" ] || [ -z "$APP_ID" ]; then
            echo ""
            echo "‚ùå Invalid configuration - APP_ID is null or empty"
            echo "‚ùå Full response:"
            echo "$RESPONSE"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Configuration loaded successfully"

  build:
    needs: [validate-secrets, fetch-config]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Notify build started
        run: |
          curl -X POST "${{ needs.fetch-config.outputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ inputs.build_id || github.event.client_payload.build_id }}",
              "status": "validating",
              "progress": 10,
              "message": "Validando configura√ß√£o de assinatura"
            }' || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK 35
        run: |
          echo "üì¶ Installing Android SDK Platform 35..."
          sdkmanager --install "platforms;android-35" "build-tools;35.0.0"
          echo "‚úÖ SDK 35 installed"

      - name: Decode keystore
        if: ${{ needs.validate-secrets.outputs.has_signing_config == 'true' }}
        run: |
          echo "üîê Decoding keystore..."
          echo "${{ secrets.UPLOAD_KEYSTORE_BASE64 }}" | tr -d '[:space:]' | base64 -d > upload-key.jks
          
          if [ -f upload-key.jks ] && [ -s upload-key.jks ]; then
            FILE_SIZE=$(stat -c%s upload-key.jks 2>/dev/null || stat -f%z upload-key.jks 2>/dev/null)
            echo "‚úÖ Keystore decoded: $FILE_SIZE bytes"
          else
            echo "‚ùå Keystore file is empty or missing!"
            exit 1
          fi

      - name: Validate web URL
        run: |
          echo "üåê Validating URL: ${{ needs.fetch-config.outputs.web_url }}"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -L "${{ needs.fetch-config.outputs.web_url }}")
          echo "üì° HTTP Status: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" != "200" ] && [ "$HTTP_STATUS" != "301" ] && [ "$HTTP_STATUS" != "302" ]; then
            echo "‚ùå URL returned status $HTTP_STATUS"
            curl -X POST "${{ needs.fetch-config.outputs.webhook_url }}" \
              -H "Content-Type: application/json" \
              -d "{\"build_id\": \"${{ inputs.build_id || github.event.client_payload.build_id }}\", \"status\": \"failed\", \"error_message\": \"URL retornou status $HTTP_STATUS\"}" || true
            exit 1
          fi
          echo "‚úÖ URL is accessible"

      - name: Create Capacitor config
        run: |
          echo '${{ needs.fetch-config.outputs.capacitor_config }}' | jq -r '.' > capacitor.config.json
          echo "üìÑ capacitor.config.json:"
          cat capacitor.config.json

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          npm install --legacy-peer-deps
          echo "‚úÖ Dependencies installed"

      - name: Create minimal web build
        run: |
          mkdir -p dist
          cat > dist/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${{ needs.fetch-config.outputs.app_name }}</title>
            <style>body{margin:0;display:flex;justify-content:center;align-items:center;height:100vh;background:#0f172a}.loader{width:48px;height:48px;border:4px solid #fff;border-bottom-color:#14b8a6;border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}</style>
          </head>
          <body><div class="loader"></div><script>window.location.href="${{ needs.fetch-config.outputs.web_url }}";</script></body>
          </html>
          EOF
          echo "‚úÖ Web build created"

      - name: Notify building
        run: |
          curl -X POST "${{ needs.fetch-config.outputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d '{"build_id": "${{ inputs.build_id || github.event.client_payload.build_id }}", "status": "building", "progress": 40, "message": "Preparando projeto Android"}' || true

      - name: Add Android platform
        run: |
          echo "üì± Adding Android platform..."
          npx cap add android
          echo "‚úÖ Android platform added"

      - name: Configure Android SDK versions (API 35)
        run: |
          echo "üîß Configuring Android SDK versions for API 35..."
          
          sed -i 's/compileSdkVersion = .*/compileSdkVersion = 35/' android/variables.gradle 2>/dev/null || true
          sed -i 's/targetSdkVersion = .*/targetSdkVersion = 35/' android/variables.gradle 2>/dev/null || true
          sed -i 's/compileSdk .*/compileSdk 35/' android/app/build.gradle 2>/dev/null || true
          sed -i 's/targetSdk .*/targetSdk 35/' android/app/build.gradle 2>/dev/null || true
          
          if [ -f android/variables.gradle ]; then
            echo "üìÑ variables.gradle:"
            cat android/variables.gradle
          fi
          
          echo "‚úÖ SDK versions configured"

      - name: Verify SDK versions
        run: |
          echo "üîç Verifying SDK configuration..."
          echo "--- variables.gradle ---"
          grep -E "(compileSdk|targetSdk)" android/variables.gradle 2>/dev/null || echo "No matches in variables.gradle"
          echo "--- app/build.gradle ---"
          grep -E "(compileSdk|targetSdk)" android/app/build.gradle 2>/dev/null || echo "No matches in build.gradle"

      - name: Download and process app icon
        if: ${{ needs.fetch-config.outputs.icon_url != '' }}
        run: |
          echo "üñºÔ∏è Downloading icon from: ${{ needs.fetch-config.outputs.icon_url }}"
          
          # Instalar ImageMagick
          sudo apt-get update
          sudo apt-get install -y imagemagick
          
          # Baixar √≠cone
          curl -L "${{ needs.fetch-config.outputs.icon_url }}" -o icon.png
          
          if [ -f icon.png ] && [ -s icon.png ]; then
            echo "‚úÖ Icon downloaded"
            
            # Gerar todos os tamanhos necess√°rios
            for size in 48 72 96 144 192; do
              folder=""
              case $size in 
                48) folder="mdpi";; 
                72) folder="hdpi";; 
                96) folder="xhdpi";; 
                144) folder="xxhdpi";; 
                192) folder="xxxhdpi";; 
              esac
              
              mkdir -p android/app/src/main/res/mipmap-$folder
              convert icon.png -resize ${size}x${size} android/app/src/main/res/mipmap-$folder/ic_launcher.png 2>/dev/null || true
              convert icon.png -resize ${size}x${size} android/app/src/main/res/mipmap-$folder/ic_launcher_round.png 2>/dev/null || true
            done
            
            echo "‚úÖ Icons processed in 5 densities"
          else
            echo "‚ö†Ô∏è Icon download failed, using default"
          fi

      - name: Sync Capacitor
        run: |
          curl -X POST "${{ needs.fetch-config.outputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d '{"build_id": "${{ inputs.build_id || github.event.client_payload.build_id }}", "status": "building", "progress": 60, "message": "Sincronizando Capacitor"}' || true
          
          echo "üîÑ Syncing Capacitor..."
          npx cap sync android
          echo "‚úÖ Capacitor synced"

      - name: Update Android configuration
        run: |
          # === 1. AUTO-INCREMENT VERSION CODE ===
          # Usamos o GITHUB_RUN_NUMBER para garantir que o c√≥digo de vers√£o sempre aumente
          VERSION_CODE=${{ github.run_number }}
          VERSION_NAME="1.0.${{ github.run_number }}"
          
          BUILD_GRADLE="android/app/build.gradle"
          if [ -f "$BUILD_GRADLE" ]; then
            sed -i "s/versionCode .*/versionCode $VERSION_CODE/" "$BUILD_GRADLE"
            sed -i "s/versionName .*/versionName \"$VERSION_NAME\"/" "$BUILD_GRADLE"
            echo "‚úÖ Version Code atualizado para: $VERSION_CODE"
            echo "‚úÖ Version Name atualizado para: $VERSION_NAME"
          fi

          # === 2. UPDATE STRINGS.XML (Nome do App) ===
          STRINGS_FILE="android/app/src/main/res/values/strings.xml"
          if [ -f "$STRINGS_FILE" ]; then
            sed -i "s|<string name=\"app_name\">.*</string>|<string name=\"app_name\">${{ needs.fetch-config.outputs.app_name }}</string>|g" "$STRINGS_FILE"
            echo "‚úÖ Nome do app atualizado em strings.xml"
          fi

          # === 3. UPDATE build.gradle (Package ID) ===
          CLEAN_PACKAGE_ID=$(echo "${{ needs.fetch-config.outputs.app_id }}" | sed 's/ (unregistered)//g')
          if [ -f "$BUILD_GRADLE" ]; then
            sed -i "s/applicationId \".*\"/applicationId \"$CLEAN_PACKAGE_ID\"/g" "$BUILD_GRADLE"
            sed -i "s/namespace \".*\"/namespace \"$CLEAN_PACKAGE_ID\"/g" "$BUILD_GRADLE"
            echo "‚úÖ Package ID limpo: $CLEAN_PACKAGE_ID"
          fi

          # === 4. UPDATE AndroidManifest.xml ===
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          if [ -f "$MANIFEST" ]; then
            sed -i "s/package=\".*\"/package=\"$CLEAN_PACKAGE_ID\"/g" "$MANIFEST"
          fi

          # === 5. UPDATE capacitor.config.json ===
          if [ -f "capacitor.config.json" ]; then
            sed -i "s/\"appId\": \".*\"/\"appId\": \"$CLEAN_PACKAGE_ID\"/g" capacitor.config.json
            sed -i "s/\"appName\": \".*\"/\"appName\": \"${{ needs.fetch-config.outputs.app_name }}\"/g" capacitor.config.json
          fi

          # === 6. UPDATE index.html (Web App) ===
          if [ -f "index.html" ]; then
            sed -i "s|<title>.*</title>|<title>${{ needs.fetch-config.outputs.app_name }}</title>|g" index.html
          fi
          
          echo "‚úÖ Configura√ß√£o do Android e Vers√£o atualizadas"

      - name: Configure signing in build.gradle
        if: ${{ needs.validate-secrets.outputs.has_signing_config == 'true' }}
        run: |
          echo "üîê Configuring signing..."
          
          cat >> android/app/build.gradle << 'SIGNING_CONFIG'
          
          android {
              signingConfigs {
                  release {
                      storeFile file("${{ github.workspace }}/upload-key.jks")
                      storePassword "${{ secrets.UPLOAD_KEYSTORE_PASSWORD }}"
                      keyAlias "${{ secrets.UPLOAD_KEY_ALIAS }}"
                      keyPassword "${{ secrets.UPLOAD_KEY_PASSWORD }}"
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          SIGNING_CONFIG
          echo "‚úÖ Signing configured"

      - name: Notify signing
        run: |
          SIGNING_MSG="${{ needs.validate-secrets.outputs.has_signing_config == 'true' && 'Assinando com Upload Key' || 'Gerando AAB (unsigned)' }}"
          curl -X POST "${{ needs.fetch-config.outputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d "{\"build_id\": \"${{ inputs.build_id || github.event.client_payload.build_id }}\", \"status\": \"signing\", \"progress\": 80, \"message\": \"$SIGNING_MSG\"}" || true

      - name: Build signed AAB
        if: ${{ needs.validate-secrets.outputs.has_signing_config == 'true' }}
        working-directory: android
        run: |
          echo "üèóÔ∏è Building signed AAB..."
          chmod +x gradlew
          ./gradlew bundleRelease --no-daemon --stacktrace
          echo "‚úÖ Signed AAB generated"

      - name: Build unsigned AAB (fallback)
        if: ${{ needs.validate-secrets.outputs.has_signing_config != 'true' }}
        working-directory: android
        run: |
          echo "üèóÔ∏è Building unsigned AAB..."
          chmod +x gradlew
          ./gradlew bundleDebug --no-daemon --stacktrace
          echo "‚ö†Ô∏è Unsigned AAB generated (configure secrets for signing)"

      - name: Build APK for testing
        working-directory: android
        run: |
          echo "üèóÔ∏è Building APK..."
          ./gradlew assembleDebug --no-daemon
          echo "‚úÖ APK generated"

      - name: Locate build outputs
        id: outputs
        run: |
          echo "üîç Locating build outputs..."
          
          APK_PATH=$(find android/app/build/outputs -name "*.apk" | head -1)
          AAB_PATH=$(find android/app/build/outputs -name "*.aab" | head -1 || echo "")
          
          echo "üì¶ APK: $APK_PATH"
          echo "üì¶ AAB: $AAB_PATH"
          
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "aab_path=$AAB_PATH" >> $GITHUB_OUTPUT
          
          if [ "${{ needs.validate-secrets.outputs.has_signing_config }}" == "true" ]; then
            echo "signed=true" >> $GITHUB_OUTPUT
          else
            echo "signed=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload APK to storage
        id: upload_apk
        run: |
          BUILD_ID="${{ inputs.build_id || github.event.client_payload.build_id }}"
          APK_PATH="${{ steps.outputs.outputs.apk_path }}"
          APP_NAME="${{ needs.fetch-config.outputs.app_name }}"
          UPLOAD_URL="https://offkayttuaeolxegjkit.supabase.co/functions/v1/upload-artifact"
          
          echo "üì§ Uploading APK to storage..."
          RESPONSE=$(curl -s -X POST "$UPLOAD_URL" \
            -F "file=@$APK_PATH" \
            -F "build_id=$BUILD_ID" \
            -F "file_type=apk" \
            -F "app_name=$APP_NAME")
          
          echo "üìÑ Response: $RESPONSE"
          
          APK_URL=$(echo "$RESPONSE" | jq -r '.url // empty')
          echo "apk_url=$APK_URL" >> $GITHUB_OUTPUT
          
          if [ -n "$APK_URL" ] && [ "$APK_URL" != "null" ]; then
            echo "‚úÖ APK uploaded: $APK_URL"
          else
            echo "‚ö†Ô∏è APK upload failed, will use artifact fallback"
          fi

      - name: Upload AAB to storage
        id: upload_aab
        if: ${{ steps.outputs.outputs.aab_path != '' }}
        run: |
          BUILD_ID="${{ inputs.build_id || github.event.client_payload.build_id }}"
          AAB_PATH="${{ steps.outputs.outputs.aab_path }}"
          APP_NAME="${{ needs.fetch-config.outputs.app_name }}"
          UPLOAD_URL="https://offkayttuaeolxegjkit.supabase.co/functions/v1/upload-artifact"
          
          echo "üì§ Uploading AAB to storage..."
          RESPONSE=$(curl -s -X POST "$UPLOAD_URL" \
            -F "file=@$AAB_PATH" \
            -F "build_id=$BUILD_ID" \
            -F "file_type=aab" \
            -F "app_name=$APP_NAME")
          
          echo "üìÑ Response: $RESPONSE"
          
          AAB_URL=$(echo "$RESPONSE" | jq -r '.url // empty')
          echo "aab_url=$AAB_URL" >> $GITHUB_OUTPUT
          
          if [ -n "$AAB_URL" ] && [ "$AAB_URL" != "null" ]; then
            echo "‚úÖ AAB uploaded: $AAB_URL"
          else
            echo "‚ö†Ô∏è AAB upload failed, will use artifact fallback"
          fi

      - name: Fallback - Upload APK artifact
        if: ${{ steps.upload_apk.outputs.apk_url == '' }}
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ inputs.build_id || github.event.client_payload.build_id }}-apk
          path: ${{ steps.outputs.outputs.apk_path }}
          retention-days: 7

      - name: Fallback - Upload AAB artifact
        if: ${{ steps.outputs.outputs.aab_path != '' && steps.upload_aab.outputs.aab_url == '' }}
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ inputs.build_id || github.event.client_payload.build_id }}-aab
          path: ${{ steps.outputs.outputs.aab_path }}
          retention-days: 7

      - name: Notify success
        if: success()
        run: |
          APK_URL="${{ steps.upload_apk.outputs.apk_url }}"
          AAB_URL="${{ steps.upload_aab.outputs.aab_url }}"
          SIGNED="${{ steps.outputs.outputs.signed }}"
          VERSION_CODE="${{ github.run_number }}"
          VERSION_NAME="1.0.${{ github.run_number }}"
          
          if [ "$SIGNED" == "true" ]; then
            MESSAGE="‚úÖ Build assinado completo! Vers√£o $VERSION_NAME (c√≥digo $VERSION_CODE). Pronto para Play Store."
          else
            MESSAGE="‚ö†Ô∏è Build completo (unsigned). Vers√£o $VERSION_NAME. Configure signing secrets para produ√ß√£o."
          fi
          
          curl -X POST "${{ needs.fetch-config.outputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"build_id\": \"${{ inputs.build_id || github.event.client_payload.build_id }}\",
              \"status\": \"complete\",
              \"progress\": 100,
              \"message\": \"$MESSAGE\",
              \"apk_url\": \"$APK_URL\",
              \"aab_url\": \"$AAB_URL\",
              \"signed\": $SIGNED,
              \"version_code\": $VERSION_CODE,
              \"version_name\": \"$VERSION_NAME\",
              \"workflow_run_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
            }" || true

      - name: Notify failure
        if: failure()
        run: |
          curl -X POST "${{ needs.fetch-config.outputs.webhook_url }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"build_id\": \"${{ inputs.build_id || github.event.client_payload.build_id }}\",
              \"status\": \"failed\",
              \"progress\": 0,
              \"error_message\": \"Build falhou. Verifique os logs do GitHub Actions.\",
              \"workflow_run_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
            }" || true
